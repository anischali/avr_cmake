#include "font.h"
#include "common.h"
#include "console.h"
#include <stdarg.h>
#include <stdio.h>
#include <string.h>

static char buffer[128];


const uint8_t xconst(ascii_5x8_font[][5]) = {
    {0x0, 0xE0, 0xFD, 0xE0, 0x0},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x03, 0x43, 0x53, 0xab, 0x54},
    {0x0},
};


void screen_write_font(struct screen_t *screen, const struct font_t *font, struct point_t *offset, const char *fmt, ...) {
    va_list args;
    struct point_t pos = { offset->x, offset->y };

    va_start(args, fmt);
    int len = sizeof(buffer);
    memset(buffer, 0x0, len);
    len = vsnprintf(buffer, len, fmt, args);

    if (!font || !font->ops || !font->ops->fill_pixels)
        return;

    for (int i = 0; i < len; ++i) {
        usart_printf("%d - %c\n\r", i, buffer[i]);
        font->ops->fill_pixels(screen, font, &pos, buffer[i] - '!');
    }
}




void ascii_5x8_fill_pixels(struct screen_t *screen, const struct font_t *font, struct point_t *offset, const char c) {
    
    const uint8_t *glyph = ascii_5x8_font[(int)c];
    static struct ebitmap_t glyph_bmp = { .width = 8, .height = 5, .bits_per_pixel = 1};

    switch(c) {
        case '\n':
            offset->y += font->height + 1;
            break;
        case '\r':
            offset->x = 0;
            break;
        default:
            glyph_bmp.pixels = (uint8_t *)glyph;
            screen_draw_bitmap(screen, &glyph_bmp, offset);
            offset->x += glyph_bmp.width + 1;
    }

}

